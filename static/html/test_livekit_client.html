<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiveKit å®¢æˆ·ç«¯æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 800px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 32px;
            text-align: center;
        }

        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            color: #667eea;
            font-size: 18px;
            margin-bottom: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            min-width: 150px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .status.show {
            display: block;
        }

        .status-connecting {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        .status-connected {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .status-disconnected {
            background: #e2e3e5;
            color: #383d41;
            border-left: 4px solid #6c757d;
        }

        .info-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 13px;
            color: #666;
            border-left: 4px solid #667eea;
        }

        .info-box pre {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }

        .audio-container {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }

        .audio-container.show {
            display: block;
        }

        .audio-visualizer {
            width: 100%;
            height: 100px;
            background: white;
            border-radius: 8px;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
        }

        .logs {
            margin-top: 20px;
            padding: 15px;
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid transparent;
        }

        .log-info { border-left-color: #4facfe; }
        .log-success { border-left-color: #28a745; }
        .log-warning { border-left-color: #ffc107; }
        .log-error { border-left-color: #dc3545; }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .badge-success {
            background: #28a745;
            color: white;
        }

        .badge-info {
            background: #17a2b8;
            color: white;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ™ï¸ LiveKit å®¢æˆ·ç«¯æµ‹è¯•</h1>
        <p class="subtitle">æµ‹è¯• LiveKit è¯­éŸ³é€šè¯é›†æˆ</p>

        <!-- çŠ¶æ€æ˜¾ç¤º -->
        <div id="status" class="status"></div>

        <!-- é…ç½®åŒº -->
        <div class="section">
            <div class="section-title">
                <span>âš™ï¸</span>
                <span>é…ç½®</span>
            </div>
            <div class="form-group">
                <label>API åœ°å€</label>
                <input type="text" id="apiUrl" value="http://localhost:8082" placeholder="http://localhost:8082">
            </div>
            <div class="form-group">
                <label>API Key (JWT Token) - å¯é€‰ï¼Œå¦‚æœæœ‰ SECRET_KEY ä¿æŠ¤åˆ™å¿…å¡«</label>
                <input type="text" id="apiKey" value="" placeholder="eyJhbGc...">
                <small style="color: #666; font-size: 12px;">ä½¿ç”¨ whatsappcall/cmd/generate_jwt ç”Ÿæˆï¼Œæˆ–ç•™ç©ºï¼ˆå¼€å‘æ¨¡å¼ï¼‰</small>
            </div>
            <div class="form-group">
                <label>å‚ä¸è€…åç§°</label>
                <input type="text" id="participantName" value="test-user" placeholder="è¾“å…¥ä½ çš„åç§°">
            </div>
            <div class="form-group">
                <label>Agent ID</label>
                <input type="text" id="agentId" value="agent-1" placeholder="é€‰æ‹© Agent">
            </div>
            <div class="form-group">
                <label>è¯­è¨€</label>
                <select id="language">
                    <option value="en">English</option>
                    <option value="zh">ä¸­æ–‡</option>
                    <option value="es">EspaÃ±ol</option>
                    <option value="fr">FranÃ§ais</option>
                </select>
            </div>
        </div>

        <!-- æ§åˆ¶æŒ‰é’® -->
        <div class="section">
            <div class="section-title">
                <span>ğŸ®</span>
                <span>æ§åˆ¶</span>
            </div>
            <div class="button-group">
                <button id="connectBtn" class="btn-primary" onclick="connectToRoom()">
                    <span>â–¶ï¸</span>
                    <span>è¿æ¥æˆ¿é—´</span>
                </button>
                <button id="disconnectBtn" class="btn-danger" onclick="disconnectFromRoom()" disabled>
                    <span>â¹ï¸</span>
                    <span>æ–­å¼€è¿æ¥</span>
                </button>
                <button id="testMicBtn" class="btn-success" onclick="testMicrophone()">
                    <span>ğŸ¤</span>
                    <span>æµ‹è¯•éº¦å…‹é£</span>
                </button>
            </div>
        </div>

        <!-- è¿æ¥ä¿¡æ¯ -->
        <div id="connectionInfo" class="info-box" style="display: none;">
            <strong>ğŸ“‹ è¿æ¥ä¿¡æ¯ï¼š</strong>
            <pre id="connectionDetails"></pre>
        </div>

        <!-- éŸ³é¢‘å®¹å™¨ -->
        <div id="audioContainer" class="audio-container">
            <div>ğŸ§ éŸ³é¢‘æ’­æ”¾åŒºåŸŸ</div>
            <div id="audioVisualizer" class="audio-visualizer">ç­‰å¾… AI å›å¤...</div>
            <div id="remoteAudio"></div>
        </div>

        <!-- æ—¥å¿— -->
        <div class="section">
            <div class="section-title">
                <span>ğŸ“</span>
                <span>æ—¥å¿—</span>
                <button onclick="clearLogs()" style="margin-left: auto; padding: 4px 12px; font-size: 12px;" class="btn-danger">
                    æ¸…ç©º
                </button>
            </div>
            <div id="logs" class="logs"></div>
        </div>
    </div>

    <!-- LiveKit Client SDK -->
    <script 
        src="https://unpkg.com/livekit-client@latest/dist/livekit-client.umd.min.js"
        onerror="console.error('Failed to load LiveKit SDK from unpkg, trying backup CDN...'); document.write('<script src=\'https://cdn.jsdelivr.net/npm/livekit-client@2/dist/livekit-client.umd.min.js\'><\/script>');">
    </script>

    <script>
        let room = null;
        let localAudioTrack = null;
        let connectionId = null;

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            log('æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(message, type) {
            const status = document.getElementById('status');
            status.className = `status status-${type} show`;
            status.textContent = message;
        }

        // æµ‹è¯•éº¦å…‹é£
        async function testMicrophone() {
            try {
                log('æ­£åœ¨æµ‹è¯•éº¦å…‹é£æƒé™...', 'info');
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                log('âœ… éº¦å…‹é£æƒé™å·²æˆäºˆ', 'success');
                
                // æ˜¾ç¤ºéŸ³é¢‘ç”µå¹³
                const audioContext = new AudioContext();
                const analyser = audioContext.createAnalyser();
                const microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                analyser.fftSize = 256;
                
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                
                let testCount = 0;
                const interval = setInterval(() => {
                    analyser.getByteFrequencyData(dataArray);
                    const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                    log(`éº¦å…‹é£ç”µå¹³: ${Math.round(average)}/255`, 'info');
                    
                    testCount++;
                    if (testCount >= 3) {
                        clearInterval(interval);
                        stream.getTracks().forEach(track => track.stop());
                        log('âœ… éº¦å…‹é£æµ‹è¯•å®Œæˆ', 'success');
                    }
                }, 1000);
                
            } catch (error) {
                log(`âŒ éº¦å…‹é£æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®');
            }
        }

        // è¿æ¥åˆ°æˆ¿é—´
        async function connectToRoom() {
            try {
                // æ£€æŸ¥ LiveKit SDK æ˜¯å¦å·²åŠ è½½
                if (typeof LivekitClient === 'undefined') {
                    alert('âŒ LiveKit SDK æœªåŠ è½½ï¼\n\nè¯·æ£€æŸ¥ï¼š\n1. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n2. æ˜¯å¦è¢«é˜²ç«å¢™é˜»æ­¢\n3. åˆ·æ–°é¡µé¢é‡è¯•');
                    log('âŒ LiveKit SDK æœªåŠ è½½ï¼Œæ— æ³•è¿æ¥', 'error');
                    return;
                }
                
                const apiUrl = document.getElementById('apiUrl').value;
                const participantName = document.getElementById('participantName').value;
                const agentId = document.getElementById('agentId').value;
                const language = document.getElementById('language').value;

                if (!participantName) {
                    alert('è¯·è¾“å…¥å‚ä¸è€…åç§°');
                    return;
                }

                updateStatus('æ­£åœ¨åˆ›å»ºæˆ¿é—´...', 'connecting');
                log('ğŸš€ å¼€å§‹è¿æ¥æµç¨‹...', 'info');
                log(`API: ${apiUrl}`, 'info');
                log(`å‚ä¸è€…: ${participantName}`, 'info');
                log(`Agent: ${agentId}`, 'info');
                log(`è¯­è¨€: ${language}`, 'info');

                // è·å– API Key
                const apiKey = document.getElementById('apiKey').value;
                
                // 1. åˆ›å»ºæˆ¿é—´å¹¶è·å– token
                log('ğŸ“ æ­£åœ¨è°ƒç”¨ /livekit/create-room API...', 'info');
                
                // æ„å»ºè¯·æ±‚å¤´
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                // å¦‚æœæœ‰ API Keyï¼Œæ·»åŠ åˆ°è¯·æ±‚å¤´
                if (apiKey) {
                    headers['X-API-Key'] = apiKey;
                    log('ğŸ”‘ ä½¿ç”¨ API Key è®¤è¯', 'info');
                }
                
                const response = await fetch(`${apiUrl}/livekit/create-room`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        participantName: participantName,
                        agentId: agentId,
                        voiceLanguage: language
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API é”™è¯¯ (${response.status}): ${errorText}`);
                }

                const data = await response.json();
                log(`âœ… æˆ¿é—´åˆ›å»ºæˆåŠŸ: ${data.roomName}`, 'success');
                log(`ğŸ”‘ Access Token: ${data.accessToken.substring(0, 50)}...`, 'info');
                
                connectionId = data.connectionId;

                // æ˜¾ç¤ºè¿æ¥ä¿¡æ¯
                document.getElementById('connectionDetails').textContent = JSON.stringify(data, null, 2);
                document.getElementById('connectionInfo').style.display = 'block';

                // 2. ä½¿ç”¨ LiveKit SDK è¿æ¥
                log('ğŸ”— æ­£åœ¨è¿æ¥åˆ° LiveKit Server...', 'info');
                room = new LivekitClient.Room();

                // è®¾ç½®äº‹ä»¶ç›‘å¬
                room.on(LivekitClient.RoomEvent.Connected, () => {
                    log('âœ… å·²è¿æ¥åˆ°æˆ¿é—´', 'success');
                    updateStatus('å·²è¿æ¥ï¼Œå‡†å¤‡å‘å¸ƒéŸ³é¢‘', 'connected');
                });

                room.on(LivekitClient.RoomEvent.TrackSubscribed, (track, publication, participant) => {
                    log(`ğŸ§ æ”¶åˆ°éŸ³é¢‘è½¨é“: ${track.kind} from ${participant.identity}`, 'success');
                    if (track.kind === 'audio') {
                        const audioElement = track.attach();
                        audioElement.volume = 1.0;
                        document.getElementById('remoteAudio').appendChild(audioElement);
                        document.getElementById('audioContainer').classList.add('show');
                        document.getElementById('audioVisualizer').textContent = 'ğŸ”Š æ­£åœ¨æ’­æ”¾ AI éŸ³é¢‘...';
                        log('âœ… AI éŸ³é¢‘å·²å¼€å§‹æ’­æ”¾', 'success');
                    }
                });

                room.on(LivekitClient.RoomEvent.TrackUnsubscribed, (track) => {
                    log(`ğŸ”‡ éŸ³é¢‘è½¨é“å·²åœæ­¢: ${track.kind}`, 'info');
                    track.detach();
                });

                room.on(LivekitClient.RoomEvent.Disconnected, () => {
                    log('ğŸ”Œ å·²æ–­å¼€è¿æ¥', 'warning');
                    updateStatus('å·²æ–­å¼€è¿æ¥', 'disconnected');
                    resetUI();
                });

                room.on(LivekitClient.RoomEvent.ParticipantConnected, (participant) => {
                    log(`ğŸ‘¤ å‚ä¸è€…åŠ å…¥: ${participant.identity}`, 'info');
                });

                // è¿æ¥åˆ°æˆ¿é—´
                await room.connect(data.serverUrl, data.accessToken);
                log('âœ… LiveKit è¿æ¥å»ºç«‹æˆåŠŸ', 'success');

                // 3. å‘å¸ƒéº¦å…‹é£éŸ³é¢‘ï¼ˆä½¿ç”¨ LiveKit SDK æ¨èé…ç½®ï¼‰
                log('ğŸ¤ æ­£åœ¨å‘å¸ƒéº¦å…‹é£éŸ³é¢‘...', 'info');
                
                // ä½¿ç”¨ LiveKit SDK çš„æœ€ä½³å®è·µ
                localAudioTrack = await LivekitClient.createLocalAudioTrack({
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true,
                    sampleRate: 48000,
                    channelCount: 1,
                });
                
                // âœ… ç”Ÿäº§æ¨¡å¼ï¼šç¦ç”¨ DTX ä»¥è·å¾—æœ€ä½³ VAD æ€§èƒ½å’Œæœ€ä½å»¶è¿Ÿ
                await room.localParticipant.publishTrack(localAudioTrack, {
                    dtx: false,  // ğŸ”¥ ç¦ç”¨ DTXï¼Œç¡®ä¿éŸ³é¢‘åŒ…æŒç»­å‘é€ï¼ŒOpenAI VAD å¿«é€Ÿå“åº”
                    audioBitrate: 32000,  // 32kbpsï¼Œä¸æœåŠ¡ç«¯ä¸€è‡´
                });
                log('âœ… éº¦å…‹é£éŸ³é¢‘å‘å¸ƒæˆåŠŸ', 'success');

                updateStatus('âœ… è¿æ¥æˆåŠŸï¼å¼€å§‹å¯¹è¯å§', 'connected');
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;

                log('ğŸ‰ ä¸€åˆ‡å°±ç»ªï¼Œå¯ä»¥å¼€å§‹å¯¹è¯äº†ï¼', 'success');

            } catch (error) {
                log(`âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                updateStatus(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                console.error('è¯¦ç»†é”™è¯¯:', error);
                resetUI();
            }
        }

        // æ–­å¼€è¿æ¥
        async function disconnectFromRoom() {
            try {
                log('ğŸ”Œ æ­£åœ¨æ–­å¼€è¿æ¥...', 'info');

                // 1. æ–­å¼€ LiveKit è¿æ¥
                if (room) {
                    room.disconnect();
                    room = null;
                }

                if (localAudioTrack) {
                    localAudioTrack.stop();
                    localAudioTrack = null;
                }

                // 2. è°ƒç”¨åç«¯ API æ¸…ç†
                if (connectionId) {
                    const apiUrl = document.getElementById('apiUrl').value;
                    const apiKey = document.getElementById('apiKey').value;
                    log(`ğŸ§¹ æ­£åœ¨æ¸…ç†æœåŠ¡ç«¯èµ„æº: ${connectionId}`, 'info');
                    
                    // æ„å»ºè¯·æ±‚å¤´
                    const headers = {
                        'Content-Type': 'application/json'
                    };
                    
                    // å¦‚æœæœ‰ API Keyï¼Œæ·»åŠ åˆ°è¯·æ±‚å¤´
                    if (apiKey) {
                        headers['X-API-Key'] = apiKey;
                    }
                    
                    const response = await fetch(`${apiUrl}/livekit/end-call`, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({
                            connectionId: connectionId
                        })
                    });

                    if (response.ok) {
                        log('âœ… æœåŠ¡ç«¯èµ„æºå·²æ¸…ç†', 'success');
                    } else {
                        log('âš ï¸ æœåŠ¡ç«¯æ¸…ç†å¤±è´¥ï¼Œä½†æœ¬åœ°å·²æ–­å¼€', 'warning');
                    }
                }

                updateStatus('å·²æ–­å¼€è¿æ¥', 'disconnected');
                log('âœ… æ–­å¼€è¿æ¥å®Œæˆ', 'success');
                resetUI();

            } catch (error) {
                log(`âŒ æ–­å¼€è¿æ¥æ—¶å‡ºé”™: ${error.message}`, 'error');
                console.error('è¯¦ç»†é”™è¯¯:', error);
                resetUI();
            }
        }

        // é‡ç½® UI
        function resetUI() {
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
            document.getElementById('connectionInfo').style.display = 'none';
            document.getElementById('audioContainer').classList.remove('show');
            document.getElementById('remoteAudio').innerHTML = '';
            connectionId = null;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('ğŸ¬ LiveKit æµ‹è¯•é¡µé¢å·²åŠ è½½', 'success');
            log('ğŸ“Œ è¯·ç¡®ä¿ LiveKit Server å’Œåç«¯æœåŠ¡å·²å¯åŠ¨', 'info');
            log('ğŸ’¡ ç‚¹å‡»"æµ‹è¯•éº¦å…‹é£"æ£€æŸ¥éŸ³é¢‘æƒé™', 'info');
            
            // æ£€æŸ¥ LiveKit SDK æ˜¯å¦åŠ è½½
            if (typeof LivekitClient !== 'undefined') {
                log(`âœ… LiveKit SDK åŠ è½½æˆåŠŸ (ç‰ˆæœ¬: ${LivekitClient.version || 'unknown'})`, 'success');
            } else {
                log('âŒ LiveKit SDK åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
            }
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (room) {
                room.disconnect();
            }
        });
    </script>
</body>
</html>

